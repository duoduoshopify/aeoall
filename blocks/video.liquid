{% comment %}
  Video Block - 视频块
{% endcomment %}

{%- liquid
  assign video_url = block.settings.video_url
  assign video_file = block.settings.video_file
  assign cover_image = block.settings.cover_image
  assign video_width = block.settings.video_width
  assign video_alignment = block.settings.video_alignment
  assign autoplay = block.settings.autoplay
  assign loop = block.settings.loop
  assign muted = block.settings.muted
  assign controls = block.settings.controls
-%}

<div class="video-block video-block--{{ video_alignment }}" {{ block.shopify_attributes }}>
  <div class="video-block__wrapper" style="max-width: {{ video_width }}px;">
    {%- if video_url != blank -%}
      {%- comment %} YouTube or Vimeo video {%- endcomment -%}
      <div class="video-block__external">
        {%- if video_url contains 'youtube.com' or video_url contains 'youtu.be' -%}
          {%- assign video_id = video_url | split: 'v=' | last | split: '&' | first -%}
          {%- if video_url contains 'youtu.be' -%}
            {%- assign video_id = video_url | split: 'youtu.be/' | last | split: '?' | first -%}
          {%- endif -%}
          <iframe
            src="https://www.youtube.com/embed/{{ video_id }}?autoplay={{ autoplay | default: 0 }}&loop={{ loop | default: 0 }}&mute={{ muted | default: 0 }}&controls={{ controls | default: 1 }}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        {%- elsif video_url contains 'vimeo.com' -%}
          {%- assign video_id = video_url | split: 'vimeo.com/' | last | split: '?' | first -%}
          <iframe
            src="https://player.vimeo.com/video/{{ video_id }}?autoplay={{ autoplay | default: 0 }}&loop={{ loop | default: 0 }}&muted={{ muted | default: 0 }}"
            frameborder="0"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
          ></iframe>
        {%- endif -%}
      </div>
    {%- elsif video_file != blank -%}
      {%- comment %} Uploaded video file {%- endcomment -%}
      <video-player class="video-block__player">
        <video
          {% if autoplay %}autoplay{% endif %}
          {% if loop %}loop{% endif %}
          {% if muted %}muted{% endif %}
          {% if controls %}controls{% endif %}
          {% if cover_image %}poster="{{ cover_image | image_url: width: 1500 }}"{% endif %}
          playsinline
        >
          <source src="{{ video_file }}" type="video/mp4">
          {{ 'blocks.video.browser_not_supported' | t }}
        </video>
        
        {%- unless controls -%}
          <button class="video-block__play-button" aria-label="{{ 'products.product.media.play_video' | t }}">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>
        {%- endunless -%}
      </video-player>
    {%- else -%}
      <div class="video-block__placeholder">
        {{ 'lifestyle-2' | placeholder_svg_tag: 'placeholder-svg' }}
        <p>{{ 'blocks.video.add_video_source' | t }}</p>
      </div>
    {%- endif -%}
  </div>
</div>

<script>
  if (!customElements.get('video-player')) {
    class VideoPlayer extends HTMLElement {
      constructor() {
        super();
        this.video = this.querySelector('video');
        this.playButton = this.querySelector('.video-block__play-button');
        
        if (this.playButton) {
          this.playButton.addEventListener('click', () => this.togglePlay());
        }

        if (this.video) {
          this.video.addEventListener('play', () => this.handlePlay());
          this.video.addEventListener('pause', () => this.handlePause());
        }
      }

      togglePlay() {
        if (this.video.paused) {
          this.video.play();
        } else {
          this.video.pause();
        }
      }

      handlePlay() {
        if (this.playButton) {
          this.playButton.style.display = 'none';
        }
      }

      handlePause() {
        if (this.playButton) {
          this.playButton.style.display = 'flex';
        }
      }
    }

    customElements.define('video-player', VideoPlayer);
  }
</script>

<style>
  .video-block {
    margin: 2rem 0;
  }

  .video-block--left .video-block__wrapper {
    margin-left: 0;
    margin-right: auto;
  }

  .video-block--center .video-block__wrapper {
    margin-left: auto;
    margin-right: auto;
  }

  .video-block--right .video-block__wrapper {
    margin-left: auto;
    margin-right: 0;
  }

  .video-block__external,
  .video-block__player {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    overflow: hidden;
    border-radius: 8px;
    background: #000;
  }

  .video-block__external iframe,
  .video-block__player video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .video-block__play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 1;
  }

  .video-block__play-button:hover {
    background: rgba(255, 255, 255, 1);
    transform: translate(-50%, -50%) scale(1.1);
  }

  .video-block__play-button svg {
    width: 32px;
    height: 32px;
    margin-left: 4px;
  }

  .video-block__placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    background: rgb(var(--color-background-secondary));
    border-radius: 8px;
    padding: 2rem;
  }

  .video-block__placeholder p {
    margin-top: 1rem;
    color: rgb(var(--color-text) / 0.7);
  }
</style>

{% schema %}
{
  "name": "Video",
  "class": "video-block",
  "settings": [
    {
      "type": "header",
      "content": "Video Source"
    },
    {
      "type": "text",
      "id": "video_url",
      "label": "Video URL",
      "info": "YouTube or Vimeo URL"
    },
    {
      "type": "text",
      "id": "video_file",
      "label": "Video File URL",
      "info": "Or upload video to Files and paste URL here"
    },
    {
      "type": "image_picker",
      "id": "cover_image",
      "label": "Cover Image",
      "info": "Shown before video plays"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "video_width",
      "min": 400,
      "max": 1500,
      "step": 50,
      "unit": "px",
      "label": "Video width",
      "default": 1000
    },
    {
      "type": "select",
      "id": "video_alignment",
      "label": "Video alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Video Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay",
      "default": false,
      "info": "Video will be muted if autoplay is enabled"
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "Loop video",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "muted",
      "label": "Mute video",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "controls",
      "label": "Show controls",
      "default": true
    }
  ]
}
{% endschema %}
