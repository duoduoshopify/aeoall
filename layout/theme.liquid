<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}">
  <head>
    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
    </script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <meta name="theme-color" content="{{ settings.colors_accent }}">
    <link rel="canonical" href="{{ canonical_url }}">

    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    {%- comment -%} 性能优化：预连接 CDN {%- endcomment -%}
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    {%- unless settings.type_header_font.system? and settings.type_body_font.system? -%}
      <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    {%- endunless -%}

    <title>
      {{ page_title }}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>

    {% if page_description %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}

    {% render 'meta-tags' %}

    {%- comment -%} 1. 核心设计系统与 CSS 变量 (从后台配置读取) {%- endcomment -%}
    {% render 'css-variables' %}
    
    {%- comment -%} 2. 基础样式库加载 {%- endcomment -%}
    {{ 'base.css' | asset_url | stylesheet_tag }}
    {%- if settings.cart_behavior_mode == 'drawer' -%}
      {{ 'component-cart-drawer.css' | asset_url | stylesheet_tag }}
    {%- endif -%}

    {%- comment -%} 3. 主题运行时数据：JSON + 轻量引导（降低内联脚本耦合） {%- endcomment -%}
    <script id="theme-data" type="application/json">
      {
        "routes": {
          "cart_add_url": {{ routes.cart_add_url | json }},
          "cart_change_url": {{ routes.cart_change_url | json }},
          "cart_update_url": {{ routes.cart_update_url | json }},
          "cart_url": {{ routes.cart_url | json }},
          "predictive_search_url": {{ routes.predictive_search_url | json }},
          "money_format": {{ shop.money_format | json }}
        },
        "cartStrings": {
          "error": {{ 'sections.cart.cart_error' | t | json }},
          "quantityError": {{ 'sections.cart.cart_quantity_error_html' | t: quantity: '[quantity]' | json }}
        },
        "variantStrings": {
          "addToCart": {{ 'products.product.add_to_cart' | t | json }},
          "soldOut": {{ 'products.product.sold_out' | t | json }},
          "unavailable": {{ 'products.product.unavailable' | t | json }}
        },
        "themeSettings": {
          "cartBehaviorMode": {{ settings.cart_behavior_mode | default: 'drawer' | json }}
        },
        "shopUrl": {{ request.origin | json }}
      }
    </script>
    <script>
      (function() {
        try {
          var themeDataNode = document.getElementById('theme-data');
          if (!themeDataNode) return;

          var parsed = JSON.parse(themeDataNode.textContent || '{}');
          window.themeData = parsed;
          window.routes = Object.assign({}, window.routes || {}, parsed.routes || {});
          window.cartStrings = Object.assign({}, window.cartStrings || {}, parsed.cartStrings || {});
          window.variantStrings = Object.assign({}, window.variantStrings || {}, parsed.variantStrings || {});
          window.themeSettings = Object.assign({}, window.themeSettings || {}, parsed.themeSettings || {});
          window.shopUrl = parsed.shopUrl || window.shopUrl || '';
        } catch (error) {
          console.warn('[Theme] Failed to parse #theme-data JSON', error);
        }
      })();
    </script>
    <!-- 性能监控（仅主题编辑器/设计模式启用，避免线上额外开销） -->
    {%- if request.design_mode -%}
      <script src="{{ 'performance.js' | asset_url }}" defer></script>
    {%- endif -%}

<!-- 对话框组件 -->
<script src="{{ 'dialog.js' | asset_url }}" defer></script>

<!-- 区段懒加载 -->
<script src="{{ 'section-hydration.js' | asset_url }}" defer></script>

<!-- 视图过渡 (渐进增强) -->
{% if settings.enable_view_transitions %}
  <script src="{{ 'view-transitions.js' | asset_url }}" defer></script>
{% endif %}



    {{ content_for_header }}
  </head>

  <body class="gradient">
    {%- comment -%} A11y: 跳过导航链接 {%- endcomment -%}
    <a class="skip-to-content-link button visually-hidden" href="#MainContent">
      {{ "accessibility.skip_to_text" | t }}
    </a>

    {%- comment -%} 4. 头部组 (Announcement + Header) {%- endcomment -%}
    {% sections 'header-group' %}

    {%- comment -%} 5. 核心内容渲染区 {%- endcomment -%}
    <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>

    {%- comment -%} 6. 页脚组 (Footer + Newsletter) {%- endcomment -%}
    {% sections 'footer-group' %}

    {%- comment -%} 7. 全局高转化组件 {%- endcomment -%}
    
    {%- comment -%} AJAX 购物车抽屉 {%- endcomment -%}
    {%- if settings.cart_behavior_mode == 'drawer' -%}
      {% section 'cart-drawer' %}
    {%- endif -%}

    {%- comment -%} 退出意图折扣弹窗 {%- endcomment -%}
    {% render 'exit-intent' %}

    {%- comment -%} 移动端吸底购买按钮 (仅在产品页显示) {%- endcomment -%}
    {%- if request.page_type == 'product' -%}
      {% render 'mobile-sticky-cta' %}
    {%- endif -%}

    {%- comment -%} 8. 全局辅助层 {%- endcomment -%}
    <ul hidden>
      <li id="a11y-refresh-page-message">{{ 'accessibility.refresh_page' | t }}</li>
      <li id="a11y-new-window-message">{{ 'accessibility.link_messages.new_window' | t }}</li>
    </ul>

    {%- comment -%} 9. 非阻塞 JavaScript 加载 {%- endcomment -%}
    <script src="{{ 'global.js' | asset_url }}" defer="defer"></script>

    {%- if settings.cart_behavior_mode == 'drawer' -%}
      <script src="{{ 'cart-drawer.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

  </body>
</html>